---
title: "nihexporter"
author: "Erin Baschal"
date: "3/10/2015"
output: html_document
---

## Examine the cost per publication for multiple PI and single PI grants, across activity types


```{r libraries, message=FALSE, warning=FALSE}
# Load Libraries
library(dplyr)
library(nihexporter)
library(ggplot2)
library(knitr)
```


### Calculate grant productivity (and cost) per PI

```{r CostPerPubPerPI, message=FALSE}
# remove grants that don't have helpful information (no project number,
# no cost available)
projects_simple.df <- projects %>%
  filter(institute %in% nih.institutes) %>%
  filter(project.num != '') %>%
  na.omit(total.cost)

# calculate a total cost for each grant across multiple fiscal years/supplements
cost.df <- projects_simple.df %>%
  group_by(project.num) %>%
  summarise(grant.cost = sum(as.numeric(total.cost))) %>%
  arrange(project.num) %>%
  distinct()

# label a column with the number of PIs on each grant
# used n_distinct due to the multiple rows for each grant for different
# fiscal years
num_PI.df <- projects_simple.df %>%
  select(project.num) %>%
  left_join(project_pis) %>%
  na.omit(pi.id) %>%
  group_by(project.num) %>%
  summarise(n.PI = n_distinct(pi.id)) %>%
  arrange(n.PI) %>%
  distinct()

# if the grant didn't have a publication, has "NA" in the pmid column
# label the NA as 0, and if it isn't NA, as 1 (so we can sum them for the
# number of publications per grant)
num_pubs.df <- projects_simple.df %>%
  select(project.num) %>%
  left_join(publinks) %>%
  mutate(pub = ifelse(is.na(pmid), 0, 1)) %>%
  group_by(project.num) %>%
  summarise(n.pub = sum(pub)) %>%
  arrange(project.num) %>%
  distinct()

# label a column with the overall activity type (R, F, P, U, K, T, Other)
activity.df <- projects_simple.df %>%
  mutate(activity.type = ifelse(grepl('^R', activity), 'R', 
                                ifelse(grepl('^F', activity), 'F', 
                                       ifelse(grepl('^P', activity), 'P', 
                                              ifelse(grepl('U', activity), 'U', 
                                                     ifelse(grepl('^K', activity), 'K', 
                                                            ifelse(grepl('^T', activity), 'T',
                                                                   'Other'))))))) %>%
  select(project.num, activity.type) %>%
  arrange(project.num) %>%
  distinct()
    
# combine data from each table
proj_combined.df <- projects_simple.df %>%
  select(institute, activity, project.num) %>%
  left_join(cost.df) %>%
  left_join(num_PI.df) %>%
  left_join(num_pubs.df) %>%
  left_join(activity.df) %>%
  arrange(project.num) %>%
  distinct()

# problem: if there are 0 publications for a grant, then you will divide by 0
# my fix was to remove these from the calculations and count them in my table 
# at the end
# calculate cost per publication and cost per publication per PI
# label grants as having one or multiple PIs
proj_calc.df <- proj_combined.df %>%
  ungroup() %>%
  na.omit(pi.id) %>%
  mutate(PI.type = ifelse(n.PI == 1, 'one_PI', 'multiple_PI')) %>%
  mutate(cost.per.pub = ifelse(n.pub != 0, grant.cost / n.pub, NA)) %>%
  mutate(PI.cost.per.pub = ifelse(! is.na(cost.per.pub), cost.per.pub / n.PI, 
                                  NA))

# remove "other" activity types (not R, F, P, U, K, or T)
proj_calc_remove.df  <- proj_calc.df %>%
  filter(activity.type != 'Other')
```


### Plot the results for cost per publication per PI, across activity types

#### F=Fellowship Programs, K= Research Career Programs, P=Research Program Projects and Centers, R=Research Projects, T=Training Programs, U=Cooperative Agreements.  Removed "Other" which includes N01, which had very large spending amounts.

```{r cost_pub_PI, message=FALSE}
# cost per publication per PI
# plot without "other" activity types
proj_calc_remove.df %>%
  ggplot(aes(x = activity.type, y = PI.cost.per.pub/1e6, 
             fill = PI.type)) +
  geom_boxplot() +
  theme_bw() +
  xlab('Activity Type') +
  ylab('Cost Per Publication Per PI (in Millions)') +
  ggtitle('Cost Per Publication Per PI for 
          Activity Types (F, K, P, R, T, U)')

# zoom in on y-axis so we can see the boxes
proj_calc_remove.df %>%
  ggplot(aes(x = activity.type, y = PI.cost.per.pub/1e6, 
             fill = PI.type)) +
  geom_boxplot() +
  theme_bw() +
  ylim(0,3) +
  xlab('Activity Type') +
  ylab('Cost Per Publication Per PI (in Millions)') +
  ggtitle('Cost Per Publication Per PI for 
          Activity Types (F, K, P, R, T, U), Zoom In')

# create a summary table
summary_act.df <- proj_calc_remove.df %>%
  group_by(activity.type, PI.type) %>%
  summarise(median.cost.per.pub.PI = round(median(PI.cost.per.pub, 
                                                  na.rm = TRUE), digits = 0), 
            mean.cost.per.pub.PI = round(mean(PI.cost.per.pub, 
                                              na.rm = TRUE), digits = 0), 
            zero.publications = sum(is.na(PI.cost.per.pub)))

kable(summary_act.df, caption = "Cost Per Publication Per PI, Multiple PI vs Single PI Grants, by Activity")

```

### Interpretation: It appears that having more than 1 PI on a grant increases your "productivity" when productivity is measured as cost per publication per PI.


### A better question might be if multiple PI grants have a higher or lower cost per publication (regardless of number of PIs) than single PI grants.

```{r cost_pub, message=FALSE}
# cost per publication (not per PI)
# plot without "other" activity types
# show outliers
proj_calc_remove.df %>%
  ggplot(aes(x = activity.type, y = cost.per.pub/1e6, fill = PI.type)) +
  geom_boxplot() +
  theme_bw() +
  xlab('Activity Type') +
  ylab('Cost Per Publication (in Millions)') +
  ggtitle('Cost Per Publication for 
          Activity Types (F, K, P, R, T, U)')

# fix y-axis so we can see the boxes
proj_calc_remove.df %>%
  ggplot(aes(x = activity.type, y = cost.per.pub/1e6, fill = PI.type)) +
  geom_boxplot() +
  theme_bw() +
  ylim(0,3) +
  xlab('Activity Type') +
  ylab('Cost Per Publication (in Millions)') +
  ggtitle('Cost Per Publication for 
          Activity Types (F, K, P, R, T, U), Zoom In')

# create a summary table
summary_mult_act.df <- proj_calc_remove.df %>%
  group_by(activity.type, PI.type) %>%
  summarize(median.cost.per.pub = round(median(cost.per.pub, na.rm = TRUE),
                                        digits = 0), 
            mean.cost.per.pub = round(mean(cost.per.pub, na.rm = TRUE), 
                                      digits = 0), 
            zero.publications = sum(is.na(cost.per.pub)))

kable(summary_mult_act.df, caption = "Cost Per Publication, Multiple PI vs Single PI Grants, by Activity")
```

### Now, multiple PI grants show a higher cost per publication (less "productive") than they were before, and are more comparable to the cost per publication for single PI grants.  This might be because they are higher cost grants (especially if they involve multiple PIs).  For the R series awards, the multiple PI grants are much more expensive per publication than the single PI grants. For the P series, the multiple PI grants are cheaper per publication than the single PI grants.  These data indicate that having more than one PI on a grant does not necessarily mean that they will produce more publications per dollar of grant funding.
